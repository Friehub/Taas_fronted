import{_ as i,o as a,c as n,ae as e}from"./chunks/framework.Dn7Y7LSn.js";const c=JSON.parse('{"title":"Production Workflow Strategy","description":"","frontmatter":{},"headers":[],"relativePath":"ops/production.md","filePath":"ops/production.md"}'),t={name:"ops/production.md"};function l(o,s,h,r,p,k){return a(),n("div",null,[...s[0]||(s[0]=[e(`<h1 id="production-workflow-strategy" tabindex="-1">Production Workflow Strategy <a class="header-anchor" href="#production-workflow-strategy" aria-label="Permalink to &quot;Production Workflow Strategy&quot;">​</a></h1><h2 id="_1-cost-analysis" tabindex="-1">1. Cost Analysis <a class="header-anchor" href="#_1-cost-analysis" aria-label="Permalink to &quot;1. Cost Analysis&quot;">​</a></h2><p><strong>Zero External Cost.</strong> Since you are using a <strong>Self-Hosted Runner</strong>:</p><ul><li>You are using the CPU/RAM of the VPS you <em>already pay for</em>.</li><li>GitHub Actions is free for public repositories, and for private repositories, you get 2000 free minutes/month (for their hosted runners). <strong>Self-hosted runners do not consume these minutes.</strong></li><li><strong>Total Extra Cost: $0.</strong></li></ul><h2 id="_2-safety-strategy-the-golden-main" tabindex="-1">2. Safety Strategy: &quot;The Golden Main&quot; <a class="header-anchor" href="#_2-safety-strategy-the-golden-main" aria-label="Permalink to &quot;2. Safety Strategy: &quot;The Golden Main&quot;&quot;">​</a></h2><p>To prevent crashing the production server (VPS), strict discipline is enforced via Git Workflow.</p><h3 id="the-branches" tabindex="-1">The Branches <a class="header-anchor" href="#the-branches" aria-label="Permalink to &quot;The Branches&quot;">​</a></h3><ol><li><strong><code>main</code> (Production)</strong>: <ul><li><strong>Rule</strong>: NEVER push directly to <code>main</code>.</li><li><strong>State</strong>: Always stable, deployable code.</li><li><strong>Action</strong>: Pushing here <em>automatically triggers</em> the deployment on the VPS.</li></ul></li><li><strong><code>develop</code> (or <code>staging</code>)</strong>: <ul><li><strong>Rule</strong>: This is your &quot;working branch&quot;.</li><li><strong>State</strong>: Latest features, might be unstable.</li><li><strong>Action</strong>: Development happens here.</li></ul></li></ol><h3 id="the-workflow-loop" tabindex="-1">The Workflow Loop <a class="header-anchor" href="#the-workflow-loop" aria-label="Permalink to &quot;The Workflow Loop&quot;">​</a></h3><ol><li><strong>Code</strong> on <code>develop</code> (or a feature branch like <code>feat/new-ui</code>).</li><li><strong>Test</strong> locally (<code>pnpm run build</code>, <code>pnpm test</code>).</li><li><strong>Push</strong> to <code>develop</code>.</li><li><strong>Open Pull Request (PR)</strong>: <code>develop</code> -&gt; <code>main</code>. <ul><li><em>Crucial Step</em>: GitHub can run &quot;Checks&quot; (like verification builds) on this PR <em>before</em> you merge.</li><li>If the checks pass, you click <strong>&quot;Squash and Merge&quot;</strong>.</li></ul></li><li><strong>Deploy</strong>: The merge to <code>main</code> triggers the Self-Hosted Runner on the VPS to pull and restart.</li></ol><h2 id="_3-implementation-plan" tabindex="-1">3. Implementation Plan <a class="header-anchor" href="#_3-implementation-plan" aria-label="Permalink to &quot;3. Implementation Plan&quot;">​</a></h2><h3 id="a-deployment-workflow-github-workflows-deploy-yml" tabindex="-1">A. Deployment Workflow (<code>.github/workflows/deploy.yml</code>) <a class="header-anchor" href="#a-deployment-workflow-github-workflows-deploy-yml" aria-label="Permalink to &quot;A. Deployment Workflow (\`.github/workflows/deploy.yml\`)&quot;">​</a></h3><p>We will create this file in your repos. It will <strong>only</strong> run when <code>main</code> processes a push.</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">Production Deploy</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">on</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  push</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    branches</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;main&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># ONLY runs on main</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">concurrency</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">production_deploy</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> # Prevents multiple deploys running at once</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">jobs</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  deploy</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    runs-on</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">self-hosted</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">production</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    steps</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">Checkout Code</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        # We don&#39;t need to checkout if we are just running commands in the existing folder,</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        # BUT for a clean history, the runner usually does its own checkout.</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        # Strategy: Runner uses its own workspace, but we run the &#39;update&#39; command </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        # on the ACTUAL app folder.</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">        run</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">echo &quot;Starting Deployment...&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">Deploy Backend</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">        run</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">          cd /home/oxisrael/prediction_market/prediction_app</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">          git fetch origin main</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">          git reset --hard origin/main</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">          pnpm install --frozen-lockfile</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">          # Build only the backend since VPS is backend-only</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">          pnpm run build --filter prediction-market-backend</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">          pm2 restart pm-backend</span></span></code></pre></div><h3 id="b-safety-check-workflow-github-workflows-ci-yml" tabindex="-1">B. Safety Check Workflow (<code>.github/workflows/ci.yml</code>) <a class="header-anchor" href="#b-safety-check-workflow-github-workflows-ci-yml" aria-label="Permalink to &quot;B. Safety Check Workflow (\`.github/workflows/ci.yml\`)&quot;">​</a></h3><p>This runs on <strong>Pull Requests</strong> to ensure you don&#39;t merge broken code.</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">Safety Check</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">on</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  pull_request</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    branches</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;main&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">jobs</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  build_verify</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    runs-on</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">ubuntu-latest</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> # Run on GitHub&#39;s servers (Free tier) to save VPS resources</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    steps</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">uses</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">actions/checkout@v3</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">uses</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">pnpm/action-setup@v2</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">run</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">pnpm install</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">run</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">pnpm run build --filter prediction-market-backend</span></span></code></pre></div><h2 id="_4-why-this-works-for-you" tabindex="-1">4. Why this works for you <a class="header-anchor" href="#_4-why-this-works-for-you" aria-label="Permalink to &quot;4. Why this works for you&quot;">​</a></h2><ul><li><strong>Server safety</strong>: The VPS only updates when you explicitly merge to <code>main</code>.</li><li><strong>Peace of mind</strong>: The <code>ci.yml</code> tells you &quot;Build Successful&quot; allowed to merge.</li><li><strong>No &quot;It works on my machine&quot;</strong>: The CI runner verifies the build in a neutral environment.</li></ul>`,19)])])}const g=i(t,[["render",l]]);export{c as __pageData,g as default};
